using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using SGMG.Data;
using SGMG.Models;
using System;
using System.Linq;
using System.Collections.Generic;
using Microsoft.Extensions.Logging;
using SGMG.Dtos.Request;
using SGMG.Dtos.Response;
using SGMG.Services;


using System.Threading.Tasks;
using SGMG.Repository;
using PROY_20252SGMG.Dtos.Request;

namespace SGMG.Controllers
{
  public class CitaController : Controller
  {
    private readonly ApplicationDbContext _context;
    private readonly ILogger<CitaController> _logger;
    private readonly ICitaService _citaService;
    private readonly ICitaRepository _citaRepository;

    public CitaController(ApplicationDbContext context, ILogger<CitaController> logger, ICitaService citaService, ICitaRepository citaRepository)
    {
      _context = context;
      _logger = logger;
      _citaService = citaService;
      _citaRepository = citaRepository;
    }

    [HttpGet]
    public IActionResult Index()
    {
      return View();
    }


    //Obtener todas las citas pendientes (sin filtros)
    [HttpGet]
    [Route("/citas/pendientes")]
    public async Task<GenericResponse<IEnumerable<CitaResponseDTO>>> GetCitasPendientes()
    {
      return await _citaService.GetCitasPendientesAsync();
    }

    //Obtener citas fuera de horario (sin filtros)
    [HttpGet]
    [Route("/citas/fuera-horario")]
    public async Task<GenericResponse<IEnumerable<CitaResponseDTO>>> GetCitasFueraHorario()
    {
      return await _citaService.GetCitasFueraHorarioAsync();
    }

    //Buscar citas pendientes con filtros   
    [HttpGet]
    [Route("/citas/buscar-pendientes")]
    public async Task<GenericResponse<IEnumerable<CitaResponseDTO>>> BuscarCitasPendientes([FromQuery] string? tipoDoc, [FromQuery] string? numeroDoc)
    {
      return await _citaService.BuscarCitasPendientesAsync(tipoDoc, numeroDoc);
    }

    [HttpGet]
    [Route("/citas/buscar-fuera-horario")]
    public async Task<GenericResponse<IEnumerable<CitaResponseDTO>>> BuscarCitasFueraHorario([FromQuery] string? tipoDoc, [FromQuery] string? numeroDoc)
    {
      return await _citaService.BuscarCitasFueraHorarioAsync(tipoDoc, numeroDoc);
    }

    [HttpGet]
    [Route("/citas/all")]
    public async Task<GenericResponse<IEnumerable<CitaResponseDTO>>> GetAllCitas()
    {
      return await _citaService.GetAllCitasAsync();
    }


    [HttpGet]
    [Route("/citas/{id}")]
    public async Task<GenericResponse<CitaResponseDTO>> GetCitaById(int id)
    {
      return await _citaService.GetCitaByIdAsync(id);
    }

    //MEDICO Y PACIENTE - VISTA HORARIO Y RESERVA CITA
    public IActionResult HorarioMedico(int? idMedico, int? idPaciente, int? semana)
    {
      if (idMedico == null || idMedico == 0)
      {
        _logger.LogWarning("Intento de acceder a HorarioMedico sin idMedico v√°lido");
        return RedirectToAction("VisualCitas");
      }

      _logger.LogInformation($"Acceso a HorarioMedico - IdMedico: {idMedico}, IdPaciente: {idPaciente}, Semana: {semana}");

      ViewBag.Semana = semana ?? 0;
      ViewBag.IdMedico = idMedico;
      ViewBag.IdPaciente = idPaciente;
      ViewData["Title"] = $"Horario del M√©dico - ID: {idMedico}";

      return View();
    }
    [HttpPut]
    [Route("/ReprogramarCita")]
    public async Task<IActionResult> ReprogramarCita([FromBody] ReprogramarCitaRequest request)
    {
      try
      {
        if (request.IdCita <= 0)
          return Json(new { success = false, mensaje = "ID de cita inv√°lido" });

        if (request.IdMedico <= 0 || request.IdPaciente <= 0)
          return Json(new { success = false, mensaje = "Datos incompletos" });

        if (string.IsNullOrEmpty(request.FechaCita) || string.IsNullOrEmpty(request.HoraCita))
          return Json(new { success = false, mensaje = "Fecha u hora inv√°lidas" });

        // Buscar la cita existente
        var cita = await _citaRepository.GetCitaByIdAsync(request.IdCita);
        if (cita == null)
          return Json(new { success = false, mensaje = "Cita no encontrada" });

        // Verificar que la cita pertenece al paciente
        if (cita.IdPaciente != request.IdPaciente)
          return Json(new { success = false, mensaje = "La cita no pertenece al paciente especificado" });

        // GUARDAR DATOS ANTERIORES PARA DEVOLVERLOS
        var fechaAnterior = cita.FechaCita.ToString("yyyy-MM-dd");
        var horaAnterior = cita.HoraCita.ToString(@"hh\:mm");
        var medicoAnterior = cita.IdMedico;

        // Verificar que el nuevo horario est√© disponible
        var fechaCita = DateTime.Parse(request.FechaCita);
        var horaCita = TimeSpan.Parse(request.HoraCita);

        // Verificar si ya existe otra cita en el nuevo horario
        var citaExistente = await _context.Citas
            .Where(c => c.IdMedico == request.IdMedico &&
                       c.FechaCita == fechaCita &&
                       c.HoraCita == horaCita &&
                       c.IdCita != request.IdCita)
            .FirstOrDefaultAsync();

        if (citaExistente != null)
          return Json(new { success = false, mensaje = "El horario seleccionado ya est√° ocupado" });

        // ACTUALIZAR DISPONIBILIDAD DEL M√âDICO ANTERIOR (si cambi√≥ de m√©dico)
        if (medicoAnterior != request.IdMedico)
        {
          var hoy = DateTime.Today;
          var diasDesdeInicio = (int)hoy.DayOfWeek - (int)DayOfWeek.Monday;
          if (diasDesdeInicio < 0) diasDesdeInicio += 7;

          var inicioSemanaBase = hoy.AddDays(-diasDesdeInicio);

          // Calcular semana de la cita anterior
          var diasDiferencia = (cita.FechaCita.Date - inicioSemanaBase.Date).Days;
          var semanaAnterior = diasDiferencia / 7;
          var inicioSemanaAnterior = inicioSemanaBase.AddDays(semanaAnterior * 7).Date;

          var disponibilidadAnterior = await _context.DisponibilidadesSemanales
              .FirstOrDefaultAsync(d => d.IdMedico == medicoAnterior &&
                                       d.FechaInicioSemana.Date == inicioSemanaAnterior.Date);

          if (disponibilidadAnterior != null && disponibilidadAnterior.CitasActuales > 0)
          {
            disponibilidadAnterior.CitasActuales--;
            _logger.LogInformation($"‚úÖ Disponibilidad del m√©dico anterior actualizada: {disponibilidadAnterior.CitasActuales}/{disponibilidadAnterior.CitasMaximas}");
          }
        }

        // Actualizar la cita
        cita.IdMedico = request.IdMedico;
        cita.FechaCita = fechaCita;
        cita.HoraCita = horaCita;
        cita.EstadoCita = "Pendiente";

        await _citaRepository.UpdateCitaAsync(cita);

        // ACTUALIZAR DISPONIBILIDAD DEL NUEVO M√âDICO (si cambi√≥ de m√©dico)
        if (medicoAnterior != request.IdMedico)
        {
          var hoy = DateTime.Today;
          var diasDesdeInicio = (int)hoy.DayOfWeek - (int)DayOfWeek.Monday;
          if (diasDesdeInicio < 0) diasDesdeInicio += 7;

          var inicioSemanaBase = hoy.AddDays(-diasDesdeInicio);
          var inicioSemana = inicioSemanaBase.AddDays(request.Semana * 7).Date;

          var disponibilidad = await _context.DisponibilidadesSemanales
              .FirstOrDefaultAsync(d => d.IdMedico == request.IdMedico &&
                                       d.FechaInicioSemana.Date == inicioSemana.Date);

          if (disponibilidad != null)
          {
            disponibilidad.CitasActuales++;
            _logger.LogInformation($"‚úÖ Disponibilidad del nuevo m√©dico actualizada: {disponibilidad.CitasActuales}/{disponibilidad.CitasMaximas}");
          }
        }

        await _context.SaveChangesAsync();

        _logger.LogInformation($"‚úÖ Cita reprogramada exitosamente: #{request.IdCita}");
        _logger.LogInformation($"   Anterior: {fechaAnterior} {horaAnterior}");
        _logger.LogInformation($"   Nueva: {cita.FechaCita:yyyy-MM-dd} {cita.HoraCita:hh\\:mm}");

        return Json(new
        {
          success = true,
          mensaje = "Cita reprogramada exitosamente",
          data = new
          {
            idCita = cita.IdCita,
            // DATOS NUEVOS
            fechaCita = cita.FechaCita.ToString("yyyy-MM-dd"),
            horaCita = cita.HoraCita.ToString(@"hh\:mm"),
            // DATOS ANTERIORES PARA DESBLOQUEAR EN EL CALENDARIO
            fechaAnterior = fechaAnterior,
            horaAnterior = horaAnterior,
            cambioMedico = medicoAnterior != request.IdMedico
          }
        });
      }
      catch (Exception ex)
      {
        _logger.LogError(ex, "Error al reprogramar cita");
        return Json(new { success = false, mensaje = "Error al reprogramar la cita: " + ex.Message });
      }
    }

    [HttpGet]
    public IActionResult ObtenerDatosCalendario(int idMedico, int semana)
    {
      try
      {
        _logger.LogInformation("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
        _logger.LogInformation("‚ïë           INICIO ObtenerDatosCalendario                        ‚ïë");
        _logger.LogInformation("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
        _logger.LogInformation($"üìã Par√°metros recibidos:");
        _logger.LogInformation($"   ‚Üí IdMedico: {idMedico}");
        _logger.LogInformation($"   ‚Üí Semana: {semana}");

        // Buscar m√©dico
        _logger.LogInformation($"üîç Buscando m√©dico con ID {idMedico}...");
        var medico = _context.Medicos
            .Include(m => m.ConsultorioAsignado)
            .FirstOrDefault(m => m.IdMedico == idMedico);

        if (medico == null)
        {
          _logger.LogWarning($"‚ùå M√©dico con ID {idMedico} NO ENCONTRADO");
          return Json(new { error = true, mensaje = "M√©dico no encontrado" });
        }

        _logger.LogInformation($"‚úÖ M√©dico encontrado:");
        _logger.LogInformation($"   ‚Üí Nombre: {medico.Nombre} {medico.ApellidoPaterno} {medico.ApellidoMaterno}");
        _logger.LogInformation($"   ‚Üí Turno: {medico.Turno}");
        _logger.LogInformation($"   ‚Üí Consultorio: {medico.ConsultorioAsignado?.Nombre ?? "No asignado"}");

        // Calcular rango de fechas de la semana
        _logger.LogInformation($"üìÖ Calculando rango de fechas...");
        var hoy = DateTime.Today;
        _logger.LogInformation($"   ‚Üí Fecha de hoy: {hoy:yyyy-MM-dd} ({hoy:dddd})");

        var diasDesdeInicio = (int)hoy.DayOfWeek - (int)DayOfWeek.Monday;
        if (diasDesdeInicio < 0) diasDesdeInicio += 7;

        _logger.LogInformation($"   ‚Üí D√≠as desde el lunes: {diasDesdeInicio}");

        var inicioSemanaBase = hoy.AddDays(-diasDesdeInicio);
        _logger.LogInformation($"   ‚Üí Inicio semana base (lunes actual): {inicioSemanaBase:yyyy-MM-dd}");

        var inicioSemana = inicioSemanaBase.AddDays(semana * 7).Date;
        var finSemana = inicioSemana.AddDays(6);

        _logger.LogInformation($"   ‚Üí Rango buscado:");
        _logger.LogInformation($"      ‚Ä¢ Inicio: {inicioSemana:yyyy-MM-dd dddd}");
        _logger.LogInformation($"      ‚Ä¢ Fin:    {finSemana:yyyy-MM-dd dddd}");

        // Obtener TODAS las disponibilidades del m√©dico
        _logger.LogInformation($"üîç Buscando disponibilidades del m√©dico en BD...");
        var todasDisponibilidades = _context.DisponibilidadesSemanales
            .Where(d => d.IdMedico == idMedico)
            .OrderBy(d => d.FechaInicioSemana)
            .ToList();

        _logger.LogInformation($"üìä Total de disponibilidades en BD: {todasDisponibilidades.Count}");

        if (todasDisponibilidades.Count == 0)
        {
          _logger.LogWarning($"‚ö†Ô∏è El m√©dico NO tiene ninguna disponibilidad registrada");
        }
        else
        {
          _logger.LogInformation($"üìã Listado de disponibilidades:");
          int contador = 1;
          foreach (var disp in todasDisponibilidades)
          {
            _logger.LogInformation($"   [{contador}] ID: {disp.IdDisponibilidad}");
            _logger.LogInformation($"       ‚Üí Inicio: {disp.FechaInicioSemana:yyyy-MM-dd}");
            _logger.LogInformation($"       ‚Üí Fin:    {disp.FechaFinSemana:yyyy-MM-dd}");
            _logger.LogInformation($"       ‚Üí Citas:  {disp.CitasActuales}/{disp.CitasMaximas}");
            contador++;
          }
        }

        // Comparar solo las fechas sin hora
        _logger.LogInformation($"üîç Buscando disponibilidad para fecha inicio: {inicioSemana:yyyy-MM-dd}");
        var disponibilidad = todasDisponibilidades
            .FirstOrDefault(d => d.FechaInicioSemana.Date == inicioSemana.Date);

        if (disponibilidad == null)
        {
          _logger.LogWarning($"‚ùå NO SE ENCONTR√ì disponibilidad para la semana solicitada");
          _logger.LogWarning($"   ‚Üí Fecha buscada: {inicioSemana:yyyy-MM-dd}");
          _logger.LogWarning($"   ‚Üí Soluci√≥n: Registrar disponibilidad para esta semana en la tabla DisponibilidadesSemanales");

          return Json(new
          {
            error = true,
            mensaje = "Semana a√∫n no establecida para el m√©dico"
          });
        }

        _logger.LogInformation($"‚úÖ Disponibilidad ENCONTRADA:");
        _logger.LogInformation($"   ‚Üí ID Disponibilidad: {disponibilidad.IdDisponibilidad}");
        _logger.LogInformation($"   ‚Üí Citas Actuales: {disponibilidad.CitasActuales}");
        _logger.LogInformation($"   ‚Üí Citas M√°ximas: {disponibilidad.CitasMaximas}");
        _logger.LogInformation($"   ‚Üí Disponibles: {disponibilidad.CitasMaximas - disponibilidad.CitasActuales}");

        // IMPORTANTE: Obtener TODAS las citas (sin importar el estado)
        // Esto asegura que los horarios ocupados se muestren correctamente
        _logger.LogInformation($"üîç Buscando citas ocupadas en el rango de fechas...");
        var citasOcupadas = _context.Citas
            .Where(c => c.IdMedico == idMedico &&
                       c.FechaCita >= inicioSemana &&
                       c.FechaCita <= finSemana)
            .Select(c => new
            {
              fecha = c.FechaCita.ToString("yyyy-MM-dd"),
              hora = c.HoraCita.ToString(@"hh\:mm"),
              estado = c.EstadoCita // Incluir estado para debugging
            })
            .ToList();

        _logger.LogInformation($"üìä Total de citas ocupadas: {citasOcupadas.Count}");

        if (citasOcupadas.Count > 0)
        {
          _logger.LogInformation($"üìã Listado de horarios ocupados:");
          int contador = 1;
          foreach (var cita in citasOcupadas)
          {
            _logger.LogInformation($"   [{contador}] Fecha: {cita.fecha}, Hora: {cita.hora}, Estado: {cita.estado}");
            contador++;
          }
        }
        else
        {
          _logger.LogInformation($"‚úÖ No hay citas ocupadas en esta semana (todos los horarios disponibles)");
        }

        // Generar fechas de la semana
        var fechasSemana = new List<string>();
        for (int i = 0; i < 7; i++)
        {
          fechasSemana.Add(inicioSemana.AddDays(i).ToString("yyyy-MM-dd"));
        }

        var nombreCompleto = $"{medico.Nombre} {medico.ApellidoPaterno} {medico.ApellidoMaterno}";

        _logger.LogInformation("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
        _logger.LogInformation("‚ïë           FIN ObtenerDatosCalendario - √âXITO ‚úÖ                ‚ïë");
        _logger.LogInformation("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");

        // Enviar solo fecha y hora (sin estado) al frontend
        return Json(new
        {
          medicoNombre = nombreCompleto,
          turno = medico.Turno,
          fechasSemana = fechasSemana,
          citasOcupadas = citasOcupadas.Select(c => new { c.fecha, c.hora }).ToList(),
          inicioSemana = inicioSemana.ToString("dd/MM/yyyy"),
          finSemana = finSemana.ToString("dd/MM/yyyy")
        });
      }
      catch (Exception ex)
      {
        _logger.LogError("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
        _logger.LogError("‚ïë                   ERROR CR√çTICO ‚ùå                              ‚ïë");
        _logger.LogError("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
        _logger.LogError($"üí• Mensaje: {ex.Message}");
        _logger.LogError($"üìç StackTrace: {ex.StackTrace}");

        return Json(new { error = true, mensaje = "Error al cargar calendario: " + ex.Message });
      }
    }

    [HttpGet]
    public IActionResult ObtenerDatosModalCita(int idMedico, int idPaciente)
    {
      try
      {
        _logger.LogInformation("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
        _logger.LogInformation("‚ïë           INICIO ObtenerDatosModalCita                         ‚ïë");
        _logger.LogInformation("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
        _logger.LogInformation($"üìã Par√°metros:");
        _logger.LogInformation($"   ‚Üí IdMedico: {idMedico}");
        _logger.LogInformation($"   ‚Üí IdPaciente: {idPaciente}");

        _logger.LogInformation($"üîç Buscando m√©dico...");
        var medico = _context.Medicos
            .Include(m => m.ConsultorioAsignado)
            .FirstOrDefault(m => m.IdMedico == idMedico);

        _logger.LogInformation($"üîç Buscando paciente...");
        var paciente = _context.Pacientes
            .FirstOrDefault(p => p.IdPaciente == idPaciente);

        if (medico == null)
        {
          _logger.LogWarning($"‚ùå M√©dico con ID {idMedico} NO ENCONTRADO");
          return Json(new { error = true, mensaje = "M√©dico no encontrado" });
        }

        if (paciente == null)
        {
          _logger.LogWarning($"‚ùå Paciente con ID {idPaciente} NO ENCONTRADO");
          return Json(new { error = true, mensaje = "Paciente no encontrado" });
        }

        var nombreMedico = $"Dr. {medico.Nombre} {medico.ApellidoPaterno} {medico.ApellidoMaterno}";
        var nombrePaciente = $"{paciente.Nombre} {paciente.ApellidoPaterno} {paciente.ApellidoMaterno}";
        var consultorio = medico.ConsultorioAsignado?.Nombre ?? "Consultorio A";

        _logger.LogInformation($"‚úÖ Datos encontrados:");
        _logger.LogInformation($"üë®‚Äç‚öïÔ∏è M√©dico:");
        _logger.LogInformation($"   ‚Üí Nombre: {nombreMedico}");
        _logger.LogInformation($"   ‚Üí Consultorio: {consultorio}");
        _logger.LogInformation($"üë§ Paciente:");
        _logger.LogInformation($"   ‚Üí Nombre: {nombrePaciente}");
        _logger.LogInformation($"   ‚Üí DNI: {paciente.NumeroDocumento}");
        _logger.LogInformation($"   ‚Üí Edad: {paciente.Edad} a√±os");

        _logger.LogInformation("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
        _logger.LogInformation("‚ïë           FIN ObtenerDatosModalCita - √âXITO ‚úÖ                 ‚ïë");
        _logger.LogInformation("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");

        return Json(new
        {
          medicoNombre = nombreMedico,
          consultorio = consultorio,
          paciente = new
          {
            dni = paciente.NumeroDocumento,
            historiaClinica = $"HC-{DateTime.Now.Year}-{paciente.IdPaciente.ToString().PadLeft(6, '0')}",
            nombreCompleto = nombrePaciente,
            edad = paciente.Edad,
            telefono = "902315786",
            correo = "No hay correo registrado"
          }
        });
      }
      catch (Exception ex)
      {
        _logger.LogError("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
        _logger.LogError("‚ïë                   ERROR CR√çTICO ‚ùå                              ‚ïë");
        _logger.LogError("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
        _logger.LogError($"üí• Mensaje: {ex.Message}");
        _logger.LogError($"üìç StackTrace: {ex.StackTrace}");

        return Json(new { error = true, mensaje = "Error: " + ex.Message });
      }
    }

    [HttpPost]
    public IActionResult RegistrarCita([FromBody] CitaRegistroDto datos)
    {
      try
      {
        _logger.LogInformation("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
        _logger.LogInformation("‚ïë                INICIO RegistrarCita                            ‚ïë");
        _logger.LogInformation("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
        _logger.LogInformation($"üìã Datos recibidos:");
        _logger.LogInformation($"   ‚Üí IdMedico: {datos.IdMedico}");
        _logger.LogInformation($"   ‚Üí IdPaciente: {datos.IdPaciente}");
        _logger.LogInformation($"   ‚Üí FechaCita: {datos.FechaCita}");
        _logger.LogInformation($"   ‚Üí HoraCita: {datos.HoraCita}");
        _logger.LogInformation($"   ‚Üí Semana: {datos.Semana}");

        _logger.LogInformation($"üîç Buscando m√©dico...");
        var medico = _context.Medicos
            .Include(m => m.ConsultorioAsignado)
            .FirstOrDefault(m => m.IdMedico == datos.IdMedico);

        if (medico == null)
        {
          _logger.LogWarning($"‚ùå M√©dico con ID {datos.IdMedico} NO ENCONTRADO");
          return Json(new { success = false, mensaje = "M√©dico no encontrado" });
        }

        _logger.LogInformation($"‚úÖ M√©dico encontrado: {medico.Nombre} {medico.ApellidoPaterno}");

        // Parsear hora
        _logger.LogInformation($"üïê Parseando hora {datos.HoraCita}...");
        var horaPartes = datos.HoraCita.Split(':');
        var horaCita = new TimeSpan(int.Parse(horaPartes[0]), int.Parse(horaPartes[1]), 0);
        _logger.LogInformation($"‚úÖ Hora parseada correctamente: {horaCita}");

        // Crear cita
        _logger.LogInformation($"üìù Creando registro de cita...");
        var nuevaCita = new Cita
        {
          IdPaciente = datos.IdPaciente,
          IdMedico = datos.IdMedico,
          Especialidad = "Medicina General",
          FechaCita = DateTime.Parse(datos.FechaCita).Date,
          HoraCita = horaCita,
          Consultorio = medico.ConsultorioAsignado?.Nombre ?? "Consultorio A",
          EstadoCita = "Pendiente",
          FechaRegistro = DateTime.Now.Date


        };
        _logger.LogInformation($"‚úÖ Registro de cita creado en memoria");
        _logger.LogInformation($"   ‚Üí Fecha: {nuevaCita.FechaCita:yyyy-MM-dd}");
        _logger.LogInformation($"   ‚Üí Hora: {nuevaCita.HoraCita}");
        _logger.LogInformation($"   ‚Üí Consultorio: {nuevaCita.Consultorio}");
        _logger.LogInformation($"   ‚Üí Estado: {nuevaCita.EstadoCita}");
        _logger.LogInformation($"   ‚Üí FechaRegistro: {nuevaCita.FechaRegistro}");
        _logger.LogInformation($"   ‚Üí Especialidad: {nuevaCita.Especialidad}");
        _logger.LogInformation($"   ‚Üí IdPaciente: {nuevaCita.IdPaciente}");
        _logger.LogInformation($"   ‚Üí IdMedico: {nuevaCita.IdMedico}");
        _logger.LogInformation($"   ‚Üí M√©dico: Dr. {medico.Nombre} {medico.ApellidoPaterno}");
        _logger.LogInformation($"   ‚Üí Paciente ID: {nuevaCita.IdPaciente}");
        _logger.LogInformation($"   ‚Üí Paciente: (ID {nuevaCita.IdPaciente})");

        _context.Citas.Add(nuevaCita);
        _logger.LogInformation($"‚úÖ Cita agregada al contexto de EF Core");

        // Actualizar disponibilidad semanal
        _logger.LogInformation($"üìÖ Calculando semana para actualizar disponibilidad...");
        var hoy = DateTime.Today;
        var diasDesdeInicio = (int)hoy.DayOfWeek - (int)DayOfWeek.Monday;
        if (diasDesdeInicio < 0) diasDesdeInicio += 7;

        var inicioSemanaBase = hoy.AddDays(-diasDesdeInicio);
        var inicioSemana = inicioSemanaBase.AddDays(datos.Semana * 7).Date;

        _logger.LogInformation($"üîç Buscando disponibilidad semanal:");
        _logger.LogInformation($"   ‚Üí Fecha inicio semana: {inicioSemana:yyyy-MM-dd}");

        var disponibilidad = _context.DisponibilidadesSemanales
            .FirstOrDefault(d => d.IdMedico == datos.IdMedico &&
                               d.FechaInicioSemana.Date == inicioSemana.Date);

        if (disponibilidad != null)
        {
          _logger.LogInformation($"‚úÖ Disponibilidad encontrada:");
          _logger.LogInformation($"   ‚Üí ID: {disponibilidad.IdDisponibilidad}");
          _logger.LogInformation($"   ‚Üí Citas actuales ANTES: {disponibilidad.CitasActuales}");

          disponibilidad.CitasActuales++;

          _logger.LogInformation($"   ‚Üí Citas actuales DESPU√âS: {disponibilidad.CitasActuales}");
          _logger.LogInformation($"   ‚Üí Citas disponibles: {disponibilidad.CitasMaximas - disponibilidad.CitasActuales}");
        }
        else
        {
          _logger.LogWarning($"‚ö†Ô∏è No se encontr√≥ disponibilidad semanal para actualizar");
          _logger.LogWarning($"   ‚Üí La cita se registrar√° pero no se actualizar√° el contador");
        }

        _logger.LogInformation($"üíæ Guardando cambios en la base de datos...");
        var registrosAfectados = _context.SaveChanges();
        _logger.LogInformation($"‚úÖ Guardado exitoso. Registros afectados: {registrosAfectados}");

        _logger.LogInformation("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
        _logger.LogInformation("‚ïë              FIN RegistrarCita - √âXITO ‚úÖ                       ‚ïë");
        _logger.LogInformation("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");

        return Json(new { success = true, mensaje = "Cita registrada exitosamente" });
      }
      catch (Exception ex)
      {
        _logger.LogError("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
        _logger.LogError("‚ïë                   ERROR CR√çTICO ‚ùå                              ‚ïë");
        _logger.LogError("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
        _logger.LogError($"üí• Mensaje: {ex.Message}");
        _logger.LogError($"üìç StackTrace: {ex.StackTrace}");

        if (ex.InnerException != null)
        {
          _logger.LogError($"üîç Inner Exception: {ex.InnerException.Message}");
        }

        return Json(new { success = false, mensaje = "Error al registrar cita: " + ex.Message });
      }
    }
  }
}